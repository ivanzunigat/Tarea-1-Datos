{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "import pandas as pd\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn as sns\n",
    "import os\n",
    "import re\n",
    "from numpy import nan as NA\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# P1 Carga y Limpieza de datos"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 1. Carga"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Adjuntamos df.head() al final de cada cambio importante para vizualizar como se va modificando"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "#Carga de los datos\n",
    "\n",
    "df_all_13 = pd.read_csv(\"../Tarea-1-Datos/data/raw/w13/metrocuadrado_all_w13.csv\", engine='python')\n",
    "df_furnished_13 = pd.read_csv(\"../Tarea-1-Datos/data/raw/w13/metrocuadrado_all_w13.csv\", engine='python')\n",
    "df_all_14 = pd.read_csv(\"../Tarea-1-Datos/data/raw/w14/metrocuadrado_all_w14.csv\", engine='python')\n",
    "df_furnished_14 = pd.read_csv(\"../Tarea-1-Datos/data/raw/w14/metrocuadrado_furnished_w14.csv\", engine='python')\n",
    "df_all_15 = pd.read_csv(\"../Tarea-1-Datos/data/raw/w15/metrocuadrado_all_w15.csv\", engine='python')\n",
    "df_furnished_15 = pd.read_csv(\"../Tarea-1-Datos/data/raw/w15/metrocuadrado_furnished_w15.csv\", engine='python')\n",
    "df_all_16 = pd.read_csv(\"../Tarea-1-Datos/data/raw/w16/metrocuadrado_all_w16.csv\", engine='python')\n",
    "df_furnished_16 = pd.read_csv(\"../Tarea-1-Datos/data/raw/w16/metrocuadrado_furnished_w16.csv\", engine='python')\n",
    "df_all_17 = pd.read_csv(\"../Tarea-1-Datos/data/raw/w17/metrocuadrado_all_w17.csv\", engine='python')\n",
    "df_furnished_17 = pd.read_csv(\"../Tarea-1-Datos/data/raw/w17/metrocuadrado_furnished_w17.csv\", engine='python')\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "El número de filas que venían de Furnished no repetidas es 1947\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>property_type|rent_type|location</th>\n",
       "      <th>price</th>\n",
       "      <th>n_rooms</th>\n",
       "      <th>n_bath</th>\n",
       "      <th>surface</th>\n",
       "      <th>details</th>\n",
       "      <th>url</th>\n",
       "      <th>metrocuadrado_index</th>\n",
       "      <th>furnished</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>Casa en Arriendo, LA SOLEDAD NORTE BogotÃ¡ D.C..</td>\n",
       "      <td>$1.050.000</td>\n",
       "      <td>3</td>\n",
       "      <td>2</td>\n",
       "      <td>63.0 m2</td>\n",
       "      <td>Excelente casa cerca de la calle 80 y Avenida ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>25.6</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>Casa en Arriendo, CIUDAD SALITRE SUR-ORIENTAL ...</td>\n",
       "      <td>$3.930.000</td>\n",
       "      <td>3</td>\n",
       "      <td>2</td>\n",
       "      <td>100.0 m2</td>\n",
       "      <td>Se arrienda casa bonita totalmente amoblada co...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>57.3</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>Casa en Arriendo, VILLA DE LOS ALPES II SECTOR...</td>\n",
       "      <td>$750.000</td>\n",
       "      <td>3</td>\n",
       "      <td>1</td>\n",
       "      <td>90.0 m2</td>\n",
       "      <td>CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>12.2</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>Casa en Arriendo, PARIS GAITAN BogotÃ¡ D.C..</td>\n",
       "      <td>$3.400.000</td>\n",
       "      <td>5</td>\n",
       "      <td>4</td>\n",
       "      <td>71.0 m2</td>\n",
       "      <td>casa ezquinera excelente ubicacion cinco alcob...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>56.0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>Casa en Arriendo, BALCONES DE ORIENTE BogotÃ¡ ...</td>\n",
       "      <td>$1.560.000</td>\n",
       "      <td>4</td>\n",
       "      <td>3</td>\n",
       "      <td>96.0 m2</td>\n",
       "      <td>Excelente casa de tres niveles, buena ubicaciÃ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>47.1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                    property_type|rent_type|location       price n_rooms  \\\n",
       "0   Casa en Arriendo, LA SOLEDAD NORTE BogotÃ¡ D.C..  $1.050.000       3   \n",
       "1  Casa en Arriendo, CIUDAD SALITRE SUR-ORIENTAL ...  $3.930.000       3   \n",
       "2  Casa en Arriendo, VILLA DE LOS ALPES II SECTOR...    $750.000       3   \n",
       "3       Casa en Arriendo, PARIS GAITAN BogotÃ¡ D.C..  $3.400.000       5   \n",
       "4  Casa en Arriendo, BALCONES DE ORIENTE BogotÃ¡ ...  $1.560.000       4   \n",
       "\n",
       "  n_bath   surface                                            details  \\\n",
       "0      2   63.0 m2  Excelente casa cerca de la calle 80 y Avenida ...   \n",
       "1      2  100.0 m2  Se arrienda casa bonita totalmente amoblada co...   \n",
       "2      1   90.0 m2  CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...   \n",
       "3      4   71.0 m2  casa ezquinera excelente ubicacion cinco alcob...   \n",
       "4      3   96.0 m2  Excelente casa de tres niveles, buena ubicaciÃ...   \n",
       "\n",
       "                                                 url  metrocuadrado_index  \\\n",
       "0  https://www.metrocuadrado.com/inmueble/arriend...                 25.6   \n",
       "1  https://www.metrocuadrado.com/inmueble/arriend...                 57.3   \n",
       "2  https://www.metrocuadrado.com/inmueble/arriend...                 12.2   \n",
       "3  https://www.metrocuadrado.com/inmueble/arriend...                 56.0   \n",
       "4  https://www.metrocuadrado.com/inmueble/arriend...                 47.1   \n",
       "\n",
       "   furnished  \n",
       "0          0  \n",
       "1          0  \n",
       "2          0  \n",
       "3          0  \n",
       "4          0  "
      ]
     },
     "execution_count": 3,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#Agregamos variable categórica que diga si viene o no de un archivo \"furnished\"\n",
    "\n",
    "df_all_13['furnished']=0\n",
    "df_all_14['furnished']=0\n",
    "df_all_15['furnished']=0\n",
    "df_all_16['furnished']=0\n",
    "df_all_17['furnished']=0\n",
    "df_furnished_13['furnished']=1\n",
    "df_furnished_14['furnished']=1\n",
    "df_furnished_15['furnished']=1\n",
    "df_furnished_16['furnished']=1\n",
    "df_furnished_17['furnished']=1\n",
    "\n",
    "\n",
    "#generamos un sólo DataFrame\n",
    "\n",
    "frames = [df_all_13, df_furnished_13, df_all_14, df_furnished_14, df_all_15, df_furnished_15, df_all_16, df_furnished_16, df_all_17, df_furnished_17]\n",
    "\n",
    "df = pd.concat(frames)\n",
    "df1 = df\n",
    "\n",
    "#Eliminamos filas duplicadas\n",
    "\n",
    "df = df.drop_duplicates(['property_type|rent_type|location', 'price', 'n_rooms', 'n_bath',\n",
    "       'surface', 'details', 'url', 'metrocuadrado_index'])\n",
    "\n",
    "#Reindexamos y ordenamos para mejorar la eficiencia\n",
    "\n",
    "df = df.reset_index(drop=True)\n",
    "df.sort_index(inplace=True)\n",
    "\n",
    "#¿cuantas filas furnished no estaban repetidas?, serán las que venían de un archivo furnished y no fueron eliminadas\n",
    "#al borrar los duplicados\n",
    "\n",
    "print(\"El número de filas que venían de Furnished no repetidas es\",len(df[df[\"furnished\"]>0]))\n",
    "\n",
    "df.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 2. Limpieza"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>property_type|rent_type|location</th>\n",
       "      <th>price</th>\n",
       "      <th>n_rooms</th>\n",
       "      <th>n_bath</th>\n",
       "      <th>surface</th>\n",
       "      <th>details</th>\n",
       "      <th>url</th>\n",
       "      <th>metrocuadrado_index</th>\n",
       "      <th>furnished</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>Casa en Arriendo, LA SOLEDAD NORTE BogotÃ¡ D.C..</td>\n",
       "      <td>1050000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>63.0</td>\n",
       "      <td>Excelente casa cerca de la calle 80 y Avenida ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>25.6</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>Casa en Arriendo, CIUDAD SALITRE SUR-ORIENTAL ...</td>\n",
       "      <td>3930000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>100.0</td>\n",
       "      <td>Se arrienda casa bonita totalmente amoblada co...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>57.3</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>Casa en Arriendo, VILLA DE LOS ALPES II SECTOR...</td>\n",
       "      <td>750000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>12.2</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>Casa en Arriendo, PARIS GAITAN BogotÃ¡ D.C..</td>\n",
       "      <td>3400000.0</td>\n",
       "      <td>5.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>71.0</td>\n",
       "      <td>casa ezquinera excelente ubicacion cinco alcob...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>56.0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>Casa en Arriendo, BALCONES DE ORIENTE BogotÃ¡ ...</td>\n",
       "      <td>1560000.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>96.0</td>\n",
       "      <td>Excelente casa de tres niveles, buena ubicaciÃ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>47.1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                    property_type|rent_type|location      price  n_rooms  \\\n",
       "0   Casa en Arriendo, LA SOLEDAD NORTE BogotÃ¡ D.C..  1050000.0      3.0   \n",
       "1  Casa en Arriendo, CIUDAD SALITRE SUR-ORIENTAL ...  3930000.0      3.0   \n",
       "2  Casa en Arriendo, VILLA DE LOS ALPES II SECTOR...   750000.0      3.0   \n",
       "3       Casa en Arriendo, PARIS GAITAN BogotÃ¡ D.C..  3400000.0      5.0   \n",
       "4  Casa en Arriendo, BALCONES DE ORIENTE BogotÃ¡ ...  1560000.0      4.0   \n",
       "\n",
       "   n_bath  surface                                            details  \\\n",
       "0     2.0     63.0  Excelente casa cerca de la calle 80 y Avenida ...   \n",
       "1     2.0    100.0  Se arrienda casa bonita totalmente amoblada co...   \n",
       "2     1.0     90.0  CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...   \n",
       "3     4.0     71.0  casa ezquinera excelente ubicacion cinco alcob...   \n",
       "4     3.0     96.0  Excelente casa de tres niveles, buena ubicaciÃ...   \n",
       "\n",
       "                                                 url  metrocuadrado_index  \\\n",
       "0  https://www.metrocuadrado.com/inmueble/arriend...                 25.6   \n",
       "1  https://www.metrocuadrado.com/inmueble/arriend...                 57.3   \n",
       "2  https://www.metrocuadrado.com/inmueble/arriend...                 12.2   \n",
       "3  https://www.metrocuadrado.com/inmueble/arriend...                 56.0   \n",
       "4  https://www.metrocuadrado.com/inmueble/arriend...                 47.1   \n",
       "\n",
       "   furnished  \n",
       "0          0  \n",
       "1          0  \n",
       "2          0  \n",
       "3          0  \n",
       "4          0  "
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "### a.\n",
    "\n",
    "#pasamos el precio de str a float\n",
    "\n",
    "df[\"price\"] = df[\"price\"].replace('[\\$,]', '', regex=True)\n",
    "df[\"price\"] = df[\"price\"].replace('[\\.,]', '', regex=True).astype(float)\n",
    "\n",
    "\n",
    "#mismo ejercicio con la superficie y resto de columnas\n",
    "df[\"surface\"] = df[\"surface\"].replace('[\\ m2,]', '', regex=True).astype(float)\n",
    "\n",
    "\n",
    "#si tiene más de 5 piezas o baños los agruparemos como que tienen 6\n",
    "df[\"n_rooms\"] = df[\"n_rooms\"].replace('[\\5+,]', '6', regex=True).astype(float)\n",
    "df[\"n_bath\"] = df[\"n_bath\"].replace('[\\5+,]', '6', regex=True).astype(float)\n",
    "\n",
    "df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Número de filas con valor NaN en locación: 260\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>price</th>\n",
       "      <th>n_rooms</th>\n",
       "      <th>n_bath</th>\n",
       "      <th>surface</th>\n",
       "      <th>details</th>\n",
       "      <th>url</th>\n",
       "      <th>metrocuadrado_index</th>\n",
       "      <th>furnished</th>\n",
       "      <th>property_type</th>\n",
       "      <th>rent_type</th>\n",
       "      <th>location</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>1050000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>63.0</td>\n",
       "      <td>Excelente casa cerca de la calle 80 y Avenida ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>25.6</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>LA SOLEDAD NORTE</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>3930000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>100.0</td>\n",
       "      <td>Se arrienda casa bonita totalmente amoblada co...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>57.3</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>CIUDAD SALITRE SUR-ORIENTAL</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>750000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>12.2</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>VILLA DE LOS ALPES II SECTOR</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>3400000.0</td>\n",
       "      <td>5.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>71.0</td>\n",
       "      <td>casa ezquinera excelente ubicacion cinco alcob...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>56.0</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>PARIS GAITAN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>1560000.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>96.0</td>\n",
       "      <td>Excelente casa de tres niveles, buena ubicaciÃ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>47.1</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>BALCONES DE ORIENTE</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       price  n_rooms  n_bath  surface  \\\n",
       "0  1050000.0      3.0     2.0     63.0   \n",
       "1  3930000.0      3.0     2.0    100.0   \n",
       "2   750000.0      3.0     1.0     90.0   \n",
       "3  3400000.0      5.0     4.0     71.0   \n",
       "4  1560000.0      4.0     3.0     96.0   \n",
       "\n",
       "                                             details  \\\n",
       "0  Excelente casa cerca de la calle 80 y Avenida ...   \n",
       "1  Se arrienda casa bonita totalmente amoblada co...   \n",
       "2  CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...   \n",
       "3  casa ezquinera excelente ubicacion cinco alcob...   \n",
       "4  Excelente casa de tres niveles, buena ubicaciÃ...   \n",
       "\n",
       "                                                 url  metrocuadrado_index  \\\n",
       "0  https://www.metrocuadrado.com/inmueble/arriend...                 25.6   \n",
       "1  https://www.metrocuadrado.com/inmueble/arriend...                 57.3   \n",
       "2  https://www.metrocuadrado.com/inmueble/arriend...                 12.2   \n",
       "3  https://www.metrocuadrado.com/inmueble/arriend...                 56.0   \n",
       "4  https://www.metrocuadrado.com/inmueble/arriend...                 47.1   \n",
       "\n",
       "   furnished property_type rent_type                      location  \n",
       "0          0          Casa  Arriendo              LA SOLEDAD NORTE  \n",
       "1          0          Casa  Arriendo   CIUDAD SALITRE SUR-ORIENTAL  \n",
       "2          0          Casa  Arriendo  VILLA DE LOS ALPES II SECTOR  \n",
       "3          0          Casa  Arriendo                  PARIS GAITAN  \n",
       "4          0          Casa  Arriendo           BALCONES DE ORIENTE  "
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "### b.\n",
    "\n",
    "#Separamos la columna original en tres y luego la eliminamos\n",
    "\n",
    "df[\"property_type\"] = df['property_type|rent_type|location'].str.split(expand=True)[0]\n",
    "df[\"property_type\"] = df[\"property_type\"].replace('[\\,,]', '', regex=True)\n",
    "\n",
    "#hay que notar que no hay casas al venta solamente, son un subconjunto de las en renta\n",
    "df[\"rent_type\"] = df['property_type|rent_type|location'].str.split(expand=True)[2]\n",
    "df[\"rent_type\"] = df[\"rent_type\"].replace('[\\,,]', '', regex=True)\n",
    "\n",
    "#nos quedamos con el nombre de la localidad\n",
    "def location(row):\n",
    "    p = re.compile(\", (.*) Bogot\")\n",
    "    result = p.search(row[\"property_type|rent_type|location\"])\n",
    "    if type(result)==type(None):\n",
    "        return NA\n",
    "    else:\n",
    "        return result.group(1)\n",
    "    \n",
    "df['location'] = df.apply (lambda row: location(row), axis=1)\n",
    "print(\"Número de filas con valor NaN en locación:\",abs(sum(df['location'].notna())-df.shape[0]))\n",
    "\n",
    "#al ser pocos datos los que no tienen locación los eliminamos pues generan problemas en el tratamiento de los datos más adelante\n",
    "#además de que al enriquecer la información estos perderan peso \n",
    "df = df[df['location'].notna()]\n",
    "\n",
    "#dflocation = df['property_type|rent_type|location'].str.split().str[-5:-2]\n",
    "#df[\"location\"] = dflocation=dflocation.iloc[:,].apply(lambda x: ' '.join(x))\n",
    "\n",
    "del df['property_type|rent_type|location']\n",
    "\n",
    "df.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 3. Calculo nuevas columnas"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>price</th>\n",
       "      <th>n_rooms</th>\n",
       "      <th>n_bath</th>\n",
       "      <th>surface</th>\n",
       "      <th>details</th>\n",
       "      <th>url</th>\n",
       "      <th>metrocuadrado_index</th>\n",
       "      <th>furnished</th>\n",
       "      <th>property_type</th>\n",
       "      <th>rent_type</th>\n",
       "      <th>location</th>\n",
       "      <th>price per m2</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>1050000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>63.0</td>\n",
       "      <td>Excelente casa cerca de la calle 80 y Avenida ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>25.6</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>LA SOLEDAD NORTE</td>\n",
       "      <td>16666.666667</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>3930000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>100.0</td>\n",
       "      <td>Se arrienda casa bonita totalmente amoblada co...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>57.3</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>CIUDAD SALITRE SUR-ORIENTAL</td>\n",
       "      <td>39300.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>750000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>12.2</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>VILLA DE LOS ALPES II SECTOR</td>\n",
       "      <td>8333.333333</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>3400000.0</td>\n",
       "      <td>5.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>71.0</td>\n",
       "      <td>casa ezquinera excelente ubicacion cinco alcob...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>56.0</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>PARIS GAITAN</td>\n",
       "      <td>47887.323944</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>1560000.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>96.0</td>\n",
       "      <td>Excelente casa de tres niveles, buena ubicaciÃ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>47.1</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>BALCONES DE ORIENTE</td>\n",
       "      <td>16250.000000</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       price  n_rooms  n_bath  surface  \\\n",
       "0  1050000.0      3.0     2.0     63.0   \n",
       "1  3930000.0      3.0     2.0    100.0   \n",
       "2   750000.0      3.0     1.0     90.0   \n",
       "3  3400000.0      5.0     4.0     71.0   \n",
       "4  1560000.0      4.0     3.0     96.0   \n",
       "\n",
       "                                             details  \\\n",
       "0  Excelente casa cerca de la calle 80 y Avenida ...   \n",
       "1  Se arrienda casa bonita totalmente amoblada co...   \n",
       "2  CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...   \n",
       "3  casa ezquinera excelente ubicacion cinco alcob...   \n",
       "4  Excelente casa de tres niveles, buena ubicaciÃ...   \n",
       "\n",
       "                                                 url  metrocuadrado_index  \\\n",
       "0  https://www.metrocuadrado.com/inmueble/arriend...                 25.6   \n",
       "1  https://www.metrocuadrado.com/inmueble/arriend...                 57.3   \n",
       "2  https://www.metrocuadrado.com/inmueble/arriend...                 12.2   \n",
       "3  https://www.metrocuadrado.com/inmueble/arriend...                 56.0   \n",
       "4  https://www.metrocuadrado.com/inmueble/arriend...                 47.1   \n",
       "\n",
       "   furnished property_type rent_type                      location  \\\n",
       "0          0          Casa  Arriendo              LA SOLEDAD NORTE   \n",
       "1          0          Casa  Arriendo   CIUDAD SALITRE SUR-ORIENTAL   \n",
       "2          0          Casa  Arriendo  VILLA DE LOS ALPES II SECTOR   \n",
       "3          0          Casa  Arriendo                  PARIS GAITAN   \n",
       "4          0          Casa  Arriendo           BALCONES DE ORIENTE   \n",
       "\n",
       "   price per m2  \n",
       "0  16666.666667  \n",
       "1  39300.000000  \n",
       "2   8333.333333  \n",
       "3  47887.323944  \n",
       "4  16250.000000  "
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "### a.\n",
    "\n",
    "#creamos función para calcular el precio por metro cuadrado, excepto los casos en que la superficie sea 0\n",
    "\n",
    "def price_per_m2 (row):\n",
    "    if row['surface'] == 0 :\n",
    "        return NA\n",
    "    else:\n",
    "        return row[\"price\"]/row[\"surface\"]\n",
    "    \n",
    "#creamos la nueva variable que guarde esta info\n",
    "\n",
    "df['price per m2'] = df.apply (lambda row: price_per_m2(row), axis=1)\n",
    "\n",
    "df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>price</th>\n",
       "      <th>n_rooms</th>\n",
       "      <th>n_bath</th>\n",
       "      <th>surface</th>\n",
       "      <th>details</th>\n",
       "      <th>url</th>\n",
       "      <th>metrocuadrado_index</th>\n",
       "      <th>furnished</th>\n",
       "      <th>property_type</th>\n",
       "      <th>rent_type</th>\n",
       "      <th>location</th>\n",
       "      <th>price per m2</th>\n",
       "      <th>n_garajes</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>1050000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>63.0</td>\n",
       "      <td>Excelente casa cerca de la calle 80 y Avenida ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>25.6</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>LA SOLEDAD NORTE</td>\n",
       "      <td>16666.666667</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>3930000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>100.0</td>\n",
       "      <td>Se arrienda casa bonita totalmente amoblada co...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>57.3</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>CIUDAD SALITRE SUR-ORIENTAL</td>\n",
       "      <td>39300.000000</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>750000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>12.2</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>VILLA DE LOS ALPES II SECTOR</td>\n",
       "      <td>8333.333333</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>3400000.0</td>\n",
       "      <td>5.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>71.0</td>\n",
       "      <td>casa ezquinera excelente ubicacion cinco alcob...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>56.0</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>PARIS GAITAN</td>\n",
       "      <td>47887.323944</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>1560000.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>96.0</td>\n",
       "      <td>Excelente casa de tres niveles, buena ubicaciÃ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>47.1</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>BALCONES DE ORIENTE</td>\n",
       "      <td>16250.000000</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       price  n_rooms  n_bath  surface  \\\n",
       "0  1050000.0      3.0     2.0     63.0   \n",
       "1  3930000.0      3.0     2.0    100.0   \n",
       "2   750000.0      3.0     1.0     90.0   \n",
       "3  3400000.0      5.0     4.0     71.0   \n",
       "4  1560000.0      4.0     3.0     96.0   \n",
       "\n",
       "                                             details  \\\n",
       "0  Excelente casa cerca de la calle 80 y Avenida ...   \n",
       "1  Se arrienda casa bonita totalmente amoblada co...   \n",
       "2  CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...   \n",
       "3  casa ezquinera excelente ubicacion cinco alcob...   \n",
       "4  Excelente casa de tres niveles, buena ubicaciÃ...   \n",
       "\n",
       "                                                 url  metrocuadrado_index  \\\n",
       "0  https://www.metrocuadrado.com/inmueble/arriend...                 25.6   \n",
       "1  https://www.metrocuadrado.com/inmueble/arriend...                 57.3   \n",
       "2  https://www.metrocuadrado.com/inmueble/arriend...                 12.2   \n",
       "3  https://www.metrocuadrado.com/inmueble/arriend...                 56.0   \n",
       "4  https://www.metrocuadrado.com/inmueble/arriend...                 47.1   \n",
       "\n",
       "   furnished property_type rent_type                      location  \\\n",
       "0          0          Casa  Arriendo              LA SOLEDAD NORTE   \n",
       "1          0          Casa  Arriendo   CIUDAD SALITRE SUR-ORIENTAL   \n",
       "2          0          Casa  Arriendo  VILLA DE LOS ALPES II SECTOR   \n",
       "3          0          Casa  Arriendo                  PARIS GAITAN   \n",
       "4          0          Casa  Arriendo           BALCONES DE ORIENTE   \n",
       "\n",
       "   price per m2  n_garajes  \n",
       "0  16666.666667          1  \n",
       "1  39300.000000          1  \n",
       "2   8333.333333          0  \n",
       "3  47887.323944          0  \n",
       "4  16250.000000          1  "
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "### b.\n",
    "\n",
    "#creamos una funcion que busca el número de garajes en el str del url\n",
    "\n",
    "def n_garajes(row):\n",
    "    p = re.compile(\"(\\d)-garaje\")\n",
    "    result = p.search(row[\"url\"])\n",
    "    if type(result)==type(None):\n",
    "        return 0\n",
    "    else:\n",
    "        return int(result.group(1))\n",
    "    \n",
    "#creamos la nueva variable que guarde esta info\n",
    "\n",
    "df['n_garajes'] = df.apply (lambda row: n_garajes(row), axis=1)\n",
    "\n",
    "df.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "###  4. Clasificación"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>price</th>\n",
       "      <th>n_rooms</th>\n",
       "      <th>n_bath</th>\n",
       "      <th>surface</th>\n",
       "      <th>details</th>\n",
       "      <th>url</th>\n",
       "      <th>metrocuadrado_index</th>\n",
       "      <th>furnished</th>\n",
       "      <th>property_type</th>\n",
       "      <th>rent_type</th>\n",
       "      <th>location</th>\n",
       "      <th>price per m2</th>\n",
       "      <th>n_garajes</th>\n",
       "      <th>product_type</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>1050000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>63.0</td>\n",
       "      <td>Excelente casa cerca de la calle 80 y Avenida ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>25.6</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>LA SOLEDAD NORTE</td>\n",
       "      <td>16666.666667</td>\n",
       "      <td>1</td>\n",
       "      <td>9</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>3930000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>100.0</td>\n",
       "      <td>Se arrienda casa bonita totalmente amoblada co...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>57.3</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>CIUDAD SALITRE SUR-ORIENTAL</td>\n",
       "      <td>39300.000000</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>750000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>12.2</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>VILLA DE LOS ALPES II SECTOR</td>\n",
       "      <td>8333.333333</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>3400000.0</td>\n",
       "      <td>5.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>71.0</td>\n",
       "      <td>casa ezquinera excelente ubicacion cinco alcob...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>56.0</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>PARIS GAITAN</td>\n",
       "      <td>47887.323944</td>\n",
       "      <td>0</td>\n",
       "      <td>9</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>1560000.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>96.0</td>\n",
       "      <td>Excelente casa de tres niveles, buena ubicaciÃ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>47.1</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>BALCONES DE ORIENTE</td>\n",
       "      <td>16250.000000</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       price  n_rooms  n_bath  surface  \\\n",
       "0  1050000.0      3.0     2.0     63.0   \n",
       "1  3930000.0      3.0     2.0    100.0   \n",
       "2   750000.0      3.0     1.0     90.0   \n",
       "3  3400000.0      5.0     4.0     71.0   \n",
       "4  1560000.0      4.0     3.0     96.0   \n",
       "\n",
       "                                             details  \\\n",
       "0  Excelente casa cerca de la calle 80 y Avenida ...   \n",
       "1  Se arrienda casa bonita totalmente amoblada co...   \n",
       "2  CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...   \n",
       "3  casa ezquinera excelente ubicacion cinco alcob...   \n",
       "4  Excelente casa de tres niveles, buena ubicaciÃ...   \n",
       "\n",
       "                                                 url  metrocuadrado_index  \\\n",
       "0  https://www.metrocuadrado.com/inmueble/arriend...                 25.6   \n",
       "1  https://www.metrocuadrado.com/inmueble/arriend...                 57.3   \n",
       "2  https://www.metrocuadrado.com/inmueble/arriend...                 12.2   \n",
       "3  https://www.metrocuadrado.com/inmueble/arriend...                 56.0   \n",
       "4  https://www.metrocuadrado.com/inmueble/arriend...                 47.1   \n",
       "\n",
       "   furnished property_type rent_type                      location  \\\n",
       "0          0          Casa  Arriendo              LA SOLEDAD NORTE   \n",
       "1          0          Casa  Arriendo   CIUDAD SALITRE SUR-ORIENTAL   \n",
       "2          0          Casa  Arriendo  VILLA DE LOS ALPES II SECTOR   \n",
       "3          0          Casa  Arriendo                  PARIS GAITAN   \n",
       "4          0          Casa  Arriendo           BALCONES DE ORIENTE   \n",
       "\n",
       "   price per m2  n_garajes  product_type  \n",
       "0  16666.666667          1             9  \n",
       "1  39300.000000          1             1  \n",
       "2   8333.333333          0             1  \n",
       "3  47887.323944          0             9  \n",
       "4  16250.000000          1             1  "
      ]
     },
     "execution_count": 8,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#Clasificamos el inmueble según los metros cuadrados, notese que hay casas y apartamentos más grandes y más pequeños que esos \n",
    "#margenes y lo apilamos en sus propias clases\n",
    "\n",
    "\n",
    "df1=df.query('property_type==\"Casa\" and 80<=surface<120')\n",
    "df2=df.query('property_type==\"Casa\" and 120<=surface<180')\n",
    "df3=df.query('property_type==\"Casa\" and 180<=surface<240')\n",
    "df4=df.query('property_type==\"Casa\" and 240<=surface<360')\n",
    "df5=df.query('property_type==\"Casa\" and 360<=surface<=460')\n",
    "df6=df.query('property_type==\"Apartamento\" and 40<=surface<60')\n",
    "df7=df.query('property_type==\"Apartamento\" and 60<=surface<80')\n",
    "df8=df.query('property_type==\"Apartamento\" and 80<=surface<=120')\n",
    "\n",
    "#clases extras definidas por nosotros\n",
    "\n",
    "df9=df.query('property_type==\"Casa\" and surface<80')\n",
    "df10=df.query('property_type==\"Casa\" and 460<surface')\n",
    "df11=df.query('property_type==\"Apartamento\" and surface<40')\n",
    "df12=df.query('property_type==\"Apartamento\" and 120<surface')\n",
    "\n",
    "#inicializamos la nueva columna\n",
    "\n",
    "df[\"product_type\"]=0\n",
    "\n",
    "#Agregamos la clasificación de cada uno según los indices\n",
    "\n",
    "for i in range(12):\n",
    "    a=globals()[\"df\" + str(i+1)]\n",
    "    for j in a.index:\n",
    "        df.loc[j, 'product_type'] = i+1\n",
    "        \n",
    "        \n",
    "df.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 5. Obtención UPZ"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [],
   "source": [
    "#importamos la info\n",
    "\n",
    "dfupz = pd.read_csv(\"../Tarea-1-Datos/data/asignacion_upz/barrio-upz.csv\", engine='python')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [],
   "source": [
    "#Nos deshacemos de los valores NaN para poder trabajar la info\n",
    "\n",
    "def pro_location(loc):\n",
    "    if type(loc) == str:\n",
    "        size = loc.strip()\n",
    "        if len(size) != 0:\n",
    "            return loc\n",
    "    else:\n",
    "        return 'NaN'\n",
    "\n",
    "dfupz['pro_location'] = dfupz['pro_location'].apply(pro_location)\n",
    "\n",
    "#mismo formato\n",
    "\n",
    "dfupz['pro_location'] = dfupz['pro_location'].apply(str.upper)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>price</th>\n",
       "      <th>n_rooms</th>\n",
       "      <th>n_bath</th>\n",
       "      <th>surface</th>\n",
       "      <th>details</th>\n",
       "      <th>url</th>\n",
       "      <th>metrocuadrado_index</th>\n",
       "      <th>furnished</th>\n",
       "      <th>property_type</th>\n",
       "      <th>rent_type</th>\n",
       "      <th>location</th>\n",
       "      <th>price per m2</th>\n",
       "      <th>n_garajes</th>\n",
       "      <th>product_type</th>\n",
       "      <th>upz</th>\n",
       "      <th>uplArea</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>1050000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>63.0</td>\n",
       "      <td>Excelente casa cerca de la calle 80 y Avenida ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>25.6</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>LA SOLEDAD NORTE</td>\n",
       "      <td>16666.666667</td>\n",
       "      <td>1</td>\n",
       "      <td>9</td>\n",
       "      <td>UPZ101</td>\n",
       "      <td>2.357008e+06</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>3930000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>100.0</td>\n",
       "      <td>Se arrienda casa bonita totalmente amoblada co...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>57.3</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>CIUDAD SALITRE SUR-ORIENTAL</td>\n",
       "      <td>39300.000000</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>-1</td>\n",
       "      <td>-1.000000e+00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>750000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>12.2</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>VILLA DE LOS ALPES II SECTOR</td>\n",
       "      <td>8333.333333</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>UPZ75</td>\n",
       "      <td>4.964574e+06</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>3400000.0</td>\n",
       "      <td>5.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>71.0</td>\n",
       "      <td>casa ezquinera excelente ubicacion cinco alcob...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>56.0</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>PARIS GAITAN</td>\n",
       "      <td>47887.323944</td>\n",
       "      <td>0</td>\n",
       "      <td>9</td>\n",
       "      <td>UPZ29</td>\n",
       "      <td>3.732645e+06</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>1560000.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>96.0</td>\n",
       "      <td>Excelente casa de tres niveles, buena ubicaciÃ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>47.1</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>BALCONES DE ORIENTE</td>\n",
       "      <td>16250.000000</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>UPZ12</td>\n",
       "      <td>2.906631e+06</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       price  n_rooms  n_bath  surface  \\\n",
       "0  1050000.0      3.0     2.0     63.0   \n",
       "1  3930000.0      3.0     2.0    100.0   \n",
       "2   750000.0      3.0     1.0     90.0   \n",
       "3  3400000.0      5.0     4.0     71.0   \n",
       "4  1560000.0      4.0     3.0     96.0   \n",
       "\n",
       "                                             details  \\\n",
       "0  Excelente casa cerca de la calle 80 y Avenida ...   \n",
       "1  Se arrienda casa bonita totalmente amoblada co...   \n",
       "2  CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...   \n",
       "3  casa ezquinera excelente ubicacion cinco alcob...   \n",
       "4  Excelente casa de tres niveles, buena ubicaciÃ...   \n",
       "\n",
       "                                                 url  metrocuadrado_index  \\\n",
       "0  https://www.metrocuadrado.com/inmueble/arriend...                 25.6   \n",
       "1  https://www.metrocuadrado.com/inmueble/arriend...                 57.3   \n",
       "2  https://www.metrocuadrado.com/inmueble/arriend...                 12.2   \n",
       "3  https://www.metrocuadrado.com/inmueble/arriend...                 56.0   \n",
       "4  https://www.metrocuadrado.com/inmueble/arriend...                 47.1   \n",
       "\n",
       "   furnished property_type rent_type                      location  \\\n",
       "0          0          Casa  Arriendo              LA SOLEDAD NORTE   \n",
       "1          0          Casa  Arriendo   CIUDAD SALITRE SUR-ORIENTAL   \n",
       "2          0          Casa  Arriendo  VILLA DE LOS ALPES II SECTOR   \n",
       "3          0          Casa  Arriendo                  PARIS GAITAN   \n",
       "4          0          Casa  Arriendo           BALCONES DE ORIENTE   \n",
       "\n",
       "   price per m2  n_garajes  product_type     upz       uplArea  \n",
       "0  16666.666667          1             9  UPZ101  2.357008e+06  \n",
       "1  39300.000000          1             1      -1 -1.000000e+00  \n",
       "2   8333.333333          0             1   UPZ75  4.964574e+06  \n",
       "3  47887.323944          0             9   UPZ29  3.732645e+06  \n",
       "4  16250.000000          1             1   UPZ12  2.906631e+06  "
      ]
     },
     "execution_count": 11,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Inicializamos la columna, sin usar valores NaN\n",
    "df['upz'] = -1\n",
    "df['uplArea'] = -1\n",
    "\n",
    "#hacemos el match según la locación\n",
    "\n",
    "def fusion_upz(df):\n",
    "    \n",
    "    locations = list(dfupz['pro_location'])\n",
    "    upz_codes = list(dfupz['UPlCodigo'])\n",
    "    uplAreas = list(dfupz['UPlArea'])\n",
    "    \n",
    "    for uplArea, upz_code, location in zip(uplAreas, upz_codes, locations):\n",
    "        ind = df[df['location'].str.contains(location)].index\n",
    "        \n",
    "        for i in ind:\n",
    "            df.loc[i,'upz'] = upz_code\n",
    "            df.loc[i,'uplArea'] = uplArea\n",
    "    \n",
    "    return df\n",
    "\n",
    "#actualizamos\n",
    "\n",
    "df = fusion_upz(df)\n",
    "\n",
    "df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Porcentaje con upz aprox: 93 % \n"
     ]
    }
   ],
   "source": [
    "#Vemos cual es el porcentaje de valores que tiene código UPZ, notamos que es cercano a lo esperado e incluso mejor\n",
    "\n",
    "print('Porcentaje con upz aprox:', int(len(df[df['upz'] != -1])/len(df)*100), \"% \")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 6. Enriquecimiento"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {},
   "outputs": [],
   "source": [
    "#Importamos la información y limpiamos un poco para manejarla mejor\n",
    "\n",
    "df_est_pob = pd.read_csv(\"../Tarea-1-Datos/data/estadisticas_upz/estadisticas_poblacion.csv\", engine='python')\n",
    "df_est_pob.drop([\"Unnamed: 0\", \"nomupz\"], axis=1, inplace=True)\n",
    "\n",
    "df_ind_ins = pd.read_csv(\"../Tarea-1-Datos/data/estadisticas_upz/indice_inseguridad.csv\", engine='python')\n",
    "df_ind_ins.drop([\"Unnamed: 0\", \"UPlNombre2\"], axis=1, inplace=True)\n",
    "df_ind_ins = df_ind_ins.rename(columns = {'UPlCodigo' : 'upz'})\n",
    "\n",
    "df_por_ver = pd.read_csv(\"../Tarea-1-Datos/data/estadisticas_upz/porcentaje_areas_verdes.csv\", engine='python')\n",
    "df_por_ver.drop([\"Unnamed: 0\"], axis=1, inplace=True)\n",
    "df_por_ver = df_por_ver.rename(columns = {'upz' : 'zone'})\n",
    "df_por_ver = df_por_ver.rename(columns = {'cod_upz' : 'upz'})\n",
    "\n",
    "#Arreglamos formato\n",
    "def por_ver(row):\n",
    "    return str(\"UPZ\"+str(int(row[\"upz\"])))\n",
    "\n",
    "df_por_ver[\"upz\"] = df_por_ver.apply (lambda row: por_ver(row), axis=1)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>price</th>\n",
       "      <th>n_rooms</th>\n",
       "      <th>n_bath</th>\n",
       "      <th>surface</th>\n",
       "      <th>details</th>\n",
       "      <th>url</th>\n",
       "      <th>metrocuadrado_index</th>\n",
       "      <th>furnished</th>\n",
       "      <th>property_type</th>\n",
       "      <th>rent_type</th>\n",
       "      <th>...</th>\n",
       "      <th>trabajoinf_ninos_5_17_anos_perc</th>\n",
       "      <th>trabajoinfampliado_ninos_5_17_anos_perc</th>\n",
       "      <th>jovenes_14_24_anos_nini_perc</th>\n",
       "      <th>indice_envegecimiento</th>\n",
       "      <th>jefe_mujer_perc</th>\n",
       "      <th>adultos_mayores_pobres_perc</th>\n",
       "      <th>zone</th>\n",
       "      <th>areas_verdes_perc</th>\n",
       "      <th>indice_inseguridad</th>\n",
       "      <th>poulation density</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>1050000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>63.0</td>\n",
       "      <td>Excelente casa cerca de la calle 80 y Avenida ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>25.6</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>...</td>\n",
       "      <td>0.6</td>\n",
       "      <td>18.4</td>\n",
       "      <td>7.2</td>\n",
       "      <td>145.7</td>\n",
       "      <td>44.896230</td>\n",
       "      <td>5.281135</td>\n",
       "      <td>Teusaquillo</td>\n",
       "      <td>6.563105</td>\n",
       "      <td>3.629032</td>\n",
       "      <td>0.008252</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>3930000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>2.0</td>\n",
       "      <td>100.0</td>\n",
       "      <td>Se arrienda casa bonita totalmente amoblada co...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>57.3</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>750000.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>1.0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>12.2</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>...</td>\n",
       "      <td>0.4</td>\n",
       "      <td>1.2</td>\n",
       "      <td>14.5</td>\n",
       "      <td>45.4</td>\n",
       "      <td>31.113458</td>\n",
       "      <td>14.928786</td>\n",
       "      <td>FontibÃ³n</td>\n",
       "      <td>21.756250</td>\n",
       "      <td>0.310559</td>\n",
       "      <td>0.036203</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>3400000.0</td>\n",
       "      <td>5.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>71.0</td>\n",
       "      <td>casa ezquinera excelente ubicacion cinco alcob...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>56.0</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>...</td>\n",
       "      <td>1.1</td>\n",
       "      <td>0.8</td>\n",
       "      <td>12.6</td>\n",
       "      <td>71.1</td>\n",
       "      <td>37.073314</td>\n",
       "      <td>8.406360</td>\n",
       "      <td>Minuto de Dios</td>\n",
       "      <td>37.852289</td>\n",
       "      <td>1.029160</td>\n",
       "      <td>0.041894</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>1560000.0</td>\n",
       "      <td>4.0</td>\n",
       "      <td>3.0</td>\n",
       "      <td>96.0</td>\n",
       "      <td>Excelente casa de tres niveles, buena ubicaciÃ...</td>\n",
       "      <td>https://www.metrocuadrado.com/inmueble/arriend...</td>\n",
       "      <td>47.1</td>\n",
       "      <td>0</td>\n",
       "      <td>Casa</td>\n",
       "      <td>Arriendo</td>\n",
       "      <td>...</td>\n",
       "      <td>1.8</td>\n",
       "      <td>16.7</td>\n",
       "      <td>9.1</td>\n",
       "      <td>54.7</td>\n",
       "      <td>36.279630</td>\n",
       "      <td>5.420442</td>\n",
       "      <td>Toberin</td>\n",
       "      <td>32.395663</td>\n",
       "      <td>3.166227</td>\n",
       "      <td>0.017215</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5 rows × 27 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "       price  n_rooms  n_bath  surface  \\\n",
       "0  1050000.0      3.0     2.0     63.0   \n",
       "1  3930000.0      3.0     2.0    100.0   \n",
       "2   750000.0      3.0     1.0     90.0   \n",
       "3  3400000.0      5.0     4.0     71.0   \n",
       "4  1560000.0      4.0     3.0     96.0   \n",
       "\n",
       "                                             details  \\\n",
       "0  Excelente casa cerca de la calle 80 y Avenida ...   \n",
       "1  Se arrienda casa bonita totalmente amoblada co...   \n",
       "2  CASA DE TRES NIVELES TRES ALCOBAS SALA COMEDOR...   \n",
       "3  casa ezquinera excelente ubicacion cinco alcob...   \n",
       "4  Excelente casa de tres niveles, buena ubicaciÃ...   \n",
       "\n",
       "                                                 url  metrocuadrado_index  \\\n",
       "0  https://www.metrocuadrado.com/inmueble/arriend...                 25.6   \n",
       "1  https://www.metrocuadrado.com/inmueble/arriend...                 57.3   \n",
       "2  https://www.metrocuadrado.com/inmueble/arriend...                 12.2   \n",
       "3  https://www.metrocuadrado.com/inmueble/arriend...                 56.0   \n",
       "4  https://www.metrocuadrado.com/inmueble/arriend...                 47.1   \n",
       "\n",
       "   furnished property_type rent_type  ... trabajoinf_ninos_5_17_anos_perc  \\\n",
       "0          0          Casa  Arriendo  ...                             0.6   \n",
       "1          0          Casa  Arriendo  ...                             NaN   \n",
       "2          0          Casa  Arriendo  ...                             0.4   \n",
       "3          0          Casa  Arriendo  ...                             1.1   \n",
       "4          0          Casa  Arriendo  ...                             1.8   \n",
       "\n",
       "   trabajoinfampliado_ninos_5_17_anos_perc  jovenes_14_24_anos_nini_perc  \\\n",
       "0                                     18.4                           7.2   \n",
       "1                                      NaN                           NaN   \n",
       "2                                      1.2                          14.5   \n",
       "3                                      0.8                          12.6   \n",
       "4                                     16.7                           9.1   \n",
       "\n",
       "   indice_envegecimiento jefe_mujer_perc  adultos_mayores_pobres_perc  \\\n",
       "0                  145.7       44.896230                     5.281135   \n",
       "1                    NaN             NaN                          NaN   \n",
       "2                   45.4       31.113458                    14.928786   \n",
       "3                   71.1       37.073314                     8.406360   \n",
       "4                   54.7       36.279630                     5.420442   \n",
       "\n",
       "             zone  areas_verdes_perc  indice_inseguridad  poulation density  \n",
       "0     Teusaquillo           6.563105            3.629032           0.008252  \n",
       "1             NaN                NaN                 NaN                NaN  \n",
       "2       FontibÃ³n          21.756250            0.310559           0.036203  \n",
       "3  Minuto de Dios          37.852289            1.029160           0.041894  \n",
       "4         Toberin          32.395663            3.166227           0.017215  \n",
       "\n",
       "[5 rows x 27 columns]"
      ]
     },
     "execution_count": 14,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#fucionamos información\n",
    "\n",
    "df_info1 = df_est_pob.merge(df_por_ver, on = 'upz',how = 'left')\n",
    "df_info = df_info1.merge(df_ind_ins, on = 'upz',how = 'left')\n",
    "df = df.merge(df_info, on = 'upz',how = 'left')\n",
    "\n",
    "\n",
    "#agregamos columna de densidad\n",
    "\n",
    "def poulation_density(row):\n",
    "    if row['uplArea'] == 0 :\n",
    "        return NA\n",
    "    else:\n",
    "        return row[\"personas\"]/row[\"uplArea\"]\n",
    "    \n",
    "df['poulation density'] = df.apply (lambda row: poulation_density(row), axis=1)\n",
    "\n",
    "df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "Int64Index: 18014 entries, 0 to 18013\n",
      "Data columns (total 27 columns):\n",
      "price                                      18014 non-null float64\n",
      "n_rooms                                    17980 non-null float64\n",
      "n_bath                                     17782 non-null float64\n",
      "surface                                    18014 non-null float64\n",
      "details                                    17949 non-null object\n",
      "url                                        18014 non-null object\n",
      "metrocuadrado_index                        18014 non-null float64\n",
      "furnished                                  18014 non-null int64\n",
      "property_type                              18014 non-null object\n",
      "rent_type                                  18014 non-null object\n",
      "location                                   18014 non-null object\n",
      "price per m2                               17737 non-null float64\n",
      "n_garajes                                  18014 non-null int64\n",
      "product_type                               18014 non-null int64\n",
      "upz                                        18014 non-null object\n",
      "uplArea                                    18014 non-null float64\n",
      "personas                                   16853 non-null float64\n",
      "trabajoinf_ninos_5_17_anos_perc            16853 non-null float64\n",
      "trabajoinfampliado_ninos_5_17_anos_perc    16853 non-null float64\n",
      "jovenes_14_24_anos_nini_perc               16853 non-null float64\n",
      "indice_envegecimiento                      16853 non-null float64\n",
      "jefe_mujer_perc                            16853 non-null float64\n",
      "adultos_mayores_pobres_perc                16853 non-null float64\n",
      "zone                                       16853 non-null object\n",
      "areas_verdes_perc                          16853 non-null float64\n",
      "indice_inseguridad                         16853 non-null float64\n",
      "poulation density                          16853 non-null float64\n",
      "dtypes: float64(17), int64(3), object(7)\n",
      "memory usage: 3.8+ MB\n"
     ]
    }
   ],
   "source": [
    "#Info dataframe resultante, númerp de columnas esperados y poca perdida de filas a lo largo del proceso (luego de la \n",
    "#eliminación de duplicados)\n",
    "\n",
    "df.info()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# P2 EDA"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# P3 Regresión Lineal Bayesiana\n",
    "\n",
    "### Desarrollo teórico:\n",
    "\n",
    "Dado un conjunto de observaciones $D= \\{(x_i,y_i)\\}_{i=1}^N$ $\\in \\mathbb{R}^{d-1}\\times \\mathbb{R}$, el modelo de regresión lineal, concibe el problema de regresión mediante el esquema:\n",
    "\n",
    "$$ y_i = w_0 + \\sum_{j=1}^{d-1}w_jx_{i,j} + \\varepsilon_j = \\textbf{w}^T\\textbf{x}_i + \\varepsilon_j \\tag{1}$$\n",
    "\n",
    "con la convención $x_{i,0} = 1$ $\\forall i\\,\\in\\{1,\\cdots,N\\}$ y con $\\varepsilon_j \\sim \\mathcal{N}(0,\\beta^{-1})$ i.i.d. $\\forall i\\,\\in\\{1,\\cdots,N\\}$. Dada la suposición de normalidad del error, es decir $\\varepsilon_j \\sim \\mathcal{N}(0,\\beta^{-1})$, la verosimilitud para una observación es expresada según\n",
    "\n",
    "$$ p(y_i|\\textbf{x}_i,\\textbf{w},\\beta)\\sim \\mathcal{N}(\\textbf{w}^T\\textbf{x}_i,\\beta^{-1}). \\tag{*}$$\n",
    "\n",
    "Para este problema, la familia de funciones aproximadoras $\\mathcal{M}$, denominada como $modelo$, corresponde a las funciones lineales representadas por $\\textbf{w}$. Así, si se escribe la verosimilitud anterior como $p(\\mathcal{D}|\\mathcal{M})$, según el Teorema de Bayes, se tiene\n",
    "\n",
    "$$ p(\\mathcal{M}|\\mathcal{D}) = \\frac{p(\\mathcal{D}|\\mathcal{M})p(\\mathcal{M})}{p(\\mathcal{D})} \\tag{2}$$\n",
    "\n",
    "Es decir, la probabilidad posterior $p(\\mathcal{M}|\\mathcal{D})$ de elegir una función aproximadora, dado el cunjunto de datos, puede ser calculada en función de una probabilidad a priori, sobre el modelo $p(\\mathcal{M})$, la verosimilitud $p(\\mathcal{D}|\\mathcal{M})$ y la evidencia $p(\\mathcal{D})$. El enfoque bayesiano consiste en modelar una probabilidad a priori $p(\\mathcal{M})$ para obtener la función que mejor modele los datos utilizando la expresión (2) para trabajar con $p(\\mathcal{M}|\\mathcal{D})$. Observe que en el caso del modelo lineal (1), obtener una expresión para $p(\\mathcal{M})$, es equivalente a modelar una distribución sobre $\\textbf{w}$."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "1. Utilice una distribución gaussiana isotrópica sobre los parámetros $\\textbf{w}$ con media cero:\n",
    "\n",
    "$$p(\\textbf{w}|\\alpha) \\sim \\mathcal{N}(0,\\alpha^{-1}\\textbf{I})$$\n",
    "\n",
    "considere que $p(\\mathcal{D})$ es una constante. Con esto, muestre que la distribución posterior de los parámetros $\\textbf{w}$ es proporcional a \n",
    "\n",
    "$$ p(\\textbf{w}|\\textbf{y},\\textbf{X},\\alpha,\\beta) \\sim \\mathcal{N}(m_N,\\textbf{S}_N)$$\n",
    "\n",
    "donde\n",
    "\n",
    "$$m_N = \\beta\\, \\textbf{S}_N\\textbf{X}^T\\textbf{y}$$\n",
    "\n",
    "$$\\textbf{S}_N^{-1} = \\alpha\\,\\textbf{I} + \\beta\\, \\textbf{X}^T\\textbf{X}$$"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "$\\textbf{Solución 1}$: Primero notemos lo siguiente. Dada la densidad $\\textit{a priori}$ de $y_i$, definamos como $\\textbf{y} = (y_1,\\cdots,y_N)^T$. Por lo tanto, por lo definido en $(*)$, sabemos que\n",
    "\n",
    "$$p(\\textbf{y}|X,\\textbf{w},\\beta) \\sim \\mathcal{N}(X\\textbf{w},\\beta^{-1}\\textbf{I}),$$\n",
    "\n",
    "donde $X$ es la matriz de observaciones, donde cada fila $i$ corresponde a un vector $\\textbf{x}_i$. Además notamos que, como todo valores $y_i$ contiene su factor aleatorio en su error $\\varepsilon_i$ (y estos son i.i.d), cada observación es independiente a la otra, es decir, las covarianzas entre $y$'s son cero y la matriz de varianza-covarianzas es $\\beta^{-1}I$. Esta matriz es diagonal, definida positiva  pues $\\beta >0$, con determinante $\\beta^{-N}$ e inversa $\\beta\\, I$. Así, tenemos que: \n",
    "\n",
    "$$p(\\mathcal{D}|\\mathcal{M}) = p(\\textbf{y}|X,\\textbf{w},\\beta) = \\left(\\frac{\\beta}{2\\pi}\\right)^{N/2}exp\\left(-\\frac{\\beta}{2}(y-X\\textbf{w})^T(y-X\\textbf{w})\\right).$$\n",
    "\n",
    "De la misma forma, viendo ahora a $\\textbf{w}$ como observación, y conociendo su distribución gaussiana, sabemos que\n",
    "\n",
    "$$p(\\mathcal{M}) = p(\\textbf{w}|\\alpha) = \\left(\\frac{\\alpha}{2\\pi}\\right)^{N/2}exp\\left(-\\frac{\\alpha}{2}\\textbf{w}^T\\textbf{w}\\right).$$\n",
    "\n",
    "Por lo tanto, \n",
    "\n",
    "$$p(\\mathcal{D}|\\mathcal{M})p(\\mathcal{M}) = \\left(\\frac{\\alpha\\beta}{4\\pi^2}\\right)^{N/2}exp\\left(-\\frac{1}{2}\\left[\\beta\\,(y-X\\textbf{w})^T(y-X\\textbf{w}) + \\alpha\\, \\textbf{w}^T\\textbf{w}\\right]\\right). \\tag{**}$$\n",
    "\n",
    "Así, lo que está al interior de la función exponencial puede ser escrito como (ignoraremos el factor común de -1/2):\n",
    "\n",
    "$$\\beta\\,y^Ty -\\beta\\,(X\\textbf{w})^Ty - \\beta\\,y^T(X\\textbf{w}) + \\beta\\,(X\\textbf{w})^T(X\\textbf{w}) + \\alpha\\,\\textbf{w}^T\\textbf{w}$$\n",
    "\n",
    "$$=\\,\\beta\\,y^Ty -\\beta\\,\\textbf{w}^TX^Ty - \\beta\\,y^TX\\textbf{w} + \\beta\\,\\textbf{w}^TX^TX\\textbf{w} + \\alpha\\,\\textbf{w}^T\\textbf{w}.$$\n",
    "\n",
    "Si juntamos los dos últimos sumandos de la expresión anterior, notamos que ambos posee en factor $\\textbf{w}^T$ al lado izquierdo y $\\textbf{w}$ al derecho, factorizando queda\n",
    "\n",
    "$$\\,\\beta\\,y^Ty -\\beta\\,\\textbf{w}^TX^Ty - \\beta\\,y^TX\\textbf{w} + \\textbf{w}^T\\left(\\alpha\\,I + \\beta\\,X^TX\\right)\\textbf{w},\\tag{***}$$\n",
    "\n",
    "donde la matriz $\\left(\\alpha\\,I + \\beta\\,X^TX\\right)$ que aparece posee las siguientes cualidades: como $X^TX$ es una matriz simétrica, entonces $\\left(\\alpha\\,I + \\beta\\,X^TX\\right)$ también lo será, si la muestra de los datos que conforman la matriz $X$ cumple lo necesario, entonces $\\left(\\alpha\\,I + \\beta\\,X^TX\\right)$ será invertible. A la inversa de esta matriz la llamaremos $S_N$. Por lo anterior, sabemos que $S_N$ también es simétrica, por lo tanto\n",
    "\n",
    "$$I = S_N\\left(\\alpha\\,I + \\beta\\,X^TX\\right) = \\left(\\alpha\\,I + \\beta\\,X^TX\\right)S_N = S_N^T\\left(\\alpha\\,I + \\beta\\,X^TX\\right) = \\left(\\alpha\\,I + \\beta\\,X^TX\\right)S_N^T.$$\n",
    "\n",
    "Tomemos el segundo sumando de la expresión en $(***)$ y veamos que:\n",
    "\n",
    "$$-\\beta\\,\\textbf{w}^TX^Ty = -\\beta\\,\\textbf{w}^T\\left(\\alpha\\,I + \\beta\\,X^TX\\right)S_NX^Ty,$$\n",
    "\n",
    "ahora hagamos algo parecido, pero con el tercer sumando:\n",
    "\n",
    "$$-\\beta\\,y^TX\\textbf{w} = -\\beta\\,y^TXS_N^T\\left(\\alpha\\,I + \\beta\\,X^TX\\right)\\textbf{w} = -\\beta\\,(S_NX^Ty)^T\\left(\\alpha\\,I + \\beta\\,X^TX\\right)\\textbf{w}$$.\n",
    "\n",
    "De este modo, reemplazando en la expresión $(***)$:\n",
    "\n",
    "$$\\beta\\,y^Ty -\\beta\\,\\textbf{w}^T\\left(\\alpha\\,I + \\beta\\,X^TX\\right)S_NX^Ty -\\beta\\,(S_NX^Ty)^T\\left(\\alpha\\,I + \\beta\\,X^TX\\right)\\textbf{w} + \\textbf{w}^T\\left(\\alpha\\,I + \\beta\\,X^TX\\right)\\textbf{w},$$\n",
    "\n",
    "podemos sumar y restar el término $\\beta^2\\,(S_NX^Ty)^T(S_NX^Ty)$ para obtener:\n",
    "\n",
    "$$\\beta\\,y^Ty - \\beta^2\\,(S_NX^Ty)^T(S_NX^Ty) + \\left(\\textbf{w}-\\beta\\,S_NX^Ty\\right)^T(\\alpha\\,I+\\beta\\,X^TX)\\left(\\textbf{w}-\\beta\\,S_NX^Ty\\right).$$\n",
    "\n",
    "Dado que estamos calculando una densidad de probabilidad para el modelo condicionado al conjunto de observaciones, nuestra variable aleatoria considerada es $\\textbf{w}$, por lo tanto el término agregado anteriormente cuenta como una constante en la densidad. Llamemos $K = \\beta\\,y^Ty - \\beta^2\\,(S_NX^Ty)^T(S_NX^Ty)$, que no depende de $\\textbf{w}$, con lo que, finalmente, la expresión queda de la forma:\n",
    "\n",
    "$$K + \\left(\\textbf{w}-\\beta\\,S_NX^Ty\\right)^T(\\alpha\\,I+\\beta\\,X^TX)\\left(\\textbf{w}-\\beta\\,S_NX^Ty\\right).$$\n",
    "\n",
    "Reemplazando esto en la fórmula $(**)$:\n",
    "\n",
    "$$p(\\mathcal{D}|\\mathcal{M})p(\\mathcal{M}) = \\left(\\frac{\\alpha\\beta}{4\\pi^2}\\right)^{N/2}exp\\left(-\\frac{1}{2}K -\\frac{1}{2}\\left(\\textbf{w}-\\beta\\,S_NX^Ty\\right)^T(\\alpha\\,I+\\beta\\,X^TX)\\left(\\textbf{w}-\\beta\\,S_NX^Ty\\right)\\right).$$\n",
    "\n",
    "$$\\Longrightarrow\\,p(\\mathcal{D}|\\mathcal{M})p(\\mathcal{M})\\,\\varpropto exp\\left(-\\frac{1}{2}\\left(\\textbf{w}-\\beta\\,S_NX^Ty\\right)^T(\\alpha\\,I+\\beta\\,X^TX)\\left(\\textbf{w}-\\beta\\,S_NX^Ty\\right)\\right) \\varpropto \\mathcal{N}(m_N,S_N),$$\n",
    "\n",
    "donde $m_N = \\beta\\,S_NX^Ty$ y también $S_N^{-1} = (\\alpha\\,I + \\beta\\,X^TX)$."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "2. Para hacer predicciones en nuevos puntos $x'$, se utiliza la probabilidad posterior predictiva, dada por\n",
    "\n",
    "$$p(y'|x',y,X,\\alpha,\\beta) = \\int p(y'|x',\\textbf{w},\\beta)\\,p(\\textbf{w}|y,X,\\alpha,\\beta)\\,d\\textbf{w}.$$\n",
    "\n",
    "Muestre que la distribución predictiva posterior para una observación $x'$ dados $\\alpha$ y $\\beta$ tiene la forma:\n",
    "\n",
    "$$p(y'|x',y,X,\\alpha,\\beta) \\,\\sim\\,\\mathcal{N}(m_N^Tx',\\sigma_N^2(x')),$$\n",
    "\n",
    "donde \n",
    "\n",
    "$$\\sigma_N^2(x') = \\frac{1}{\\beta} + x'^TS_Nx'$$"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "$\\textbf{Solución 2:}$ Primero aclaremos que de la parte anterior podemos asumir que\n",
    "\n",
    "$$p(\\textbf{w}|y,X,\\alpha,\\beta) = p(\\mathcal{M}|\\mathcal{D})\\,\\sim\\,\\mathcal{N}(m_N,S_N),$$\n",
    "\n",
    "puesto que las constantes que aparecían en el desarrollo anterior son normalizadas por $p(\\mathcal{D})$ (al momento de dividir), quien es el que arregla los valores para que $p(\\mathcal{M}|\\mathcal{D})$ sea efectiamente una densidad.\n",
    "\n",
    "Ocupando esta lógica tenemos que:\n",
    "\n",
    "$$p(y'|x',y,X,\\alpha,\\beta) = \\int p(y'|x',\\textbf{w},\\beta)\\,p(\\textbf{w}|y,X,\\alpha,\\beta)\\,d\\textbf{w} = \\int\\,\\mathcal{N}(y';\\textbf{w}^Tx',\\beta^{-1})\\,\\mathcal{N}(\\textbf{w};m_N,S_N)\\,d\\textbf{w}$$\n",
    "\n",
    "$$\\varpropto\\,\\int\\,exp\\left(-\\frac{\\beta}{2}(y'-\\textbf{w}^Tx')^2\\right)\\,exp\\left(-\\frac{1}{2}(\\textbf{w}-m_n)^TS_N^{-1}(\\textbf{w} - m_N)\\right).\\tag{a}$$\n",
    "\n",
    "Podemos ir deshechando todo término que no dependa de $\\textbf{w}$, ni de $y'$, así encontrar una distribución que sea proporcional a la que tenemos. Luego, por el mismo argumento anterior (si dos densidades son proporcionalmente iguales, entonces son la misma densidad), concluímos que son la misma.\n",
    "\n",
    "Factorizando por -1/2, lo que queda adentro de la multiplicación de las funciones exponenciales al interior de la integral es (para aligerar la notación, diremos que $y := y'$ y $x := x'$):\n",
    "\n",
    "$$\\beta\\,(y - \\textbf{w}^Tx)^2 + \\textbf{w}^TS_N^{-1}\\textbf{w} -m_N^TS_N^{-1}\\textbf{w} - \\textbf{w}^TS_N^{-1}m_N + m_N^TS_N^{-1}m_N $$\n",
    "\n",
    "El término $m_N^TS^{-1}m_N$, que depende sólo de la base de datos anterior $X$, $\\alpha$ y $\\beta$, es constante para $\\textbf{w}$  e $y$. Por lo tanto, la exponencial de este sumando será sacado de la integral e ignorado en nuestro cálculo. Por otro lado, notemos que todos los sumandos anteriores son números reales, así que no importa si consideramos este cálculo y su multiplicación traspuesta; como lo es en el caso de $m_N^TS_N^{-1}\\textbf{w}$.\n",
    "\n",
    "Esto quiere decir que $m_N^TS_N^{-1}\\textbf{w} = \\left(m_N^TS_N^{-1}\\textbf{w}\\right)^T = \\textbf{w}^TS_N^{-1}m_N$ (recordar que la matriz $S_N^{-1}$ es simétrica), así podemos dejar la expresión anterior como:\n",
    "\n",
    "$$\\beta(y-\\textbf{w}^Tx)^2 + \\textbf{w}^TS_N^{-1}\\textbf{w} - 2\\textbf{w}^TS_N^{-1}m_N$$\n",
    "\n",
    "$$ = \\beta\\,y^2 - 2y\\beta\\,\\textbf{w}^Tx + \\beta\\,(\\textbf{w}^Tx)^2 + \\textbf{w}^TS_N^{-1}\\textbf{w} - 2\\textbf{w}^TS_N^{-1}m_N$$\n",
    "\n",
    "$$ = \\beta\\,y^2 - 2y\\beta\\,\\textbf{w}^Tx + \\beta\\,\\textbf{w}^Tx\\,x^T\\textbf{w} + \\textbf{w}^TS_N^{-1}\\textbf{w} - 2\\textbf{w}^TS_N^{-1}m_N.$$\n",
    "\n",
    "Ahora podemos factorizar todos los términos cuadráticos y  lineales para $\\textbf{w}$:\n",
    "\n",
    "$$\\beta\\,y^2 +\\textbf{w}^T\\left(\\beta\\,xx^T + S_N^{-1}\\right)\\textbf{w} - 2\\textbf{w}^T\\left(\\beta\\,yx + S_N^{-1}m_N\\right).$$\n",
    "\n",
    "Notemos primero que: la matriz $xx^T = (x_ix_j)_{ij,}$ definida así es simétrica, por lo tanto definiendo $L^{-1} = \\beta\\,xx^T + S_N^{-1}$, y $\\mu = L\\,\\left(\\beta\\,yx + S_N^{-1}m_N\\right)$ volvemos  reformular la expresión anterior de la forma:\n",
    "\n",
    "$$\\beta\\,y^2 + \\textbf{w}^TL^{-1}\\textbf{w} - 2\\textbf{w}^T\\,\\mu$$\n",
    "\n",
    "$$ = \\beta\\,y^2 + \\textbf{w}^TL^{-1}\\textbf{w} - 2\\textbf{w}^T\\,\\mu + \\mu^TL^{-1}\\mu - \\mu^TL^{-1}\\mu$$\n",
    "\n",
    "$$ = \\beta\\,y^2 - \\mu^TL^{-1}\\mu + (\\textbf{w} - \\mu)^TL^{-1}(\\textbf{w} - \\mu).$$\n",
    "\n",
    "Reemplazando este resultado en $(a)$ tenemos que:\n",
    "\n",
    "$$p(y|x,y,X,\\alpha,\\beta) \\varpropto\\,\\int exp\\left(-\\frac{1}{2}\\beta\\,y^2 + \\frac{1}{2}\\mu^TL^{-1}\\mu\\right)\\,exp\\left(-\\frac{1}{2}(\\textbf{w} - \\mu)^TL^{-1}(\\textbf{w} - \\mu)\\right)\\,d\\textbf{w}$$\n",
    "\n",
    "$$\\varpropto exp\\left(-\\frac{1}{2}\\beta\\,y^2 + \\frac{1}{2}\\mu^TL^{-1}\\mu\\right)\\,\\int \\mathcal{N}(\\textbf{w};\\mu,L)\\,d\\textbf{w}$$\n",
    "\n",
    "donde la integral normal, de parámetros $\\mu$ y $L$, integra 1. Sólo queda buscar una densidad que sea proporcional a la función que nos quedó dependiendo de $y$ (cuadráticamente y en $\\mu$ adentro de la exponencial). Para ello veamos que:\n",
    "\n",
    "$$\\mu^TL^{-1}\\mu = \\left(\\beta\\,yx + S_N^{-1}m_N\\right)^TLL^{-1}L\\left(\\beta\\,yx + S_N^{-1}m_N\\right)$$\n",
    "\n",
    "$$ = \\beta^2\\,y^2x^TLx + 2\\beta\\,yx^TLS_N^{-1}m_N + S_N^{-1}m_N^TLm_NS_N^{-1}$$\n",
    "\n",
    "Juntándolo con el término restante, nuévamente factorizando por -1/2 al interior de la exponencial (e ignorádolo), lo que queda al interior es:\n",
    "\n",
    "$$\\beta y^2 \\left(1 -\\beta\\,x^TLx\\right) - 2\\beta\\,yx^TLS_N^{-1}m_N - S_N^{-1}m_N^TLm_NS_N^{-1}.$$\n",
    "\n",
    "Nuevamente el último sumando no depende de $y$ y será omitido, y apartado de los cálculos por corresponder a una constante.\n",
    "\n",
    "$$\\beta y^2 \\left(1 -\\beta\\,x^TLx\\right) - 2\\beta\\,yx^TLS_N^{-1}m_N. $$\n",
    "\n",
    "Por último, aplicaremos una completación de binomio cuadrado para encontrar el término que nos falta al interior de la exponencial, así encontrar una distribución normal:\n",
    "\n",
    "$$ a(y-b)^2 = ay^2 -2aby - ab^2 = \\beta y^2 \\left(1 -\\beta\\,x^TLx\\right) - 2\\beta\\,yx^TLS_N^{-1}m_N + \\text{término faltante}$$\n",
    "\n",
    "$$\\Longrightarrow\\hspace{0.2cm}a =\\beta\\,\\left(1 -\\beta\\,x^TLx\\right),\\hspace{0.3cm}ab= \\beta\\,x^TLS_N^{-1}m_N$$\n",
    "\n",
    "$$\\Longrightarrow\\hspace{0.2cm}b = \\frac{x^TLS_N^{-1}m_N}{\\left(1 -\\beta\\,x^TLx\\right)}, \\hspace{0.3cm}a =\\beta\\,\\left(1 -\\beta\\,x^TLx\\right).\\tag{****}$$\n",
    "\n",
    "Ahora podemos decir que:\n",
    "\n",
    "$$p(y|x,y,X,\\alpha,\\beta) \\varpropto\\, exp\\left(-\\frac{a}{2}(y-b)^2\\right) \\varpropto\\,\\mathcal{N}(y;b,a^{-1}).$$\n",
    "\n",
    "\n",
    "#### Calculando a y b.\n",
    "Para hacer esto es necesario calcular la inversa de la Matriz $L= (S_N^{-1} + \\beta\\,xx^T)^{-1}$, para esto, ocuparemos la identidad de $Woodbury$, para invertir matrices de esta forma:\n",
    "\n",
    "$$(S_N^{-1} + \\beta\\,xx^T)^{-1} = S_N  - S_Nx\\left(\\beta^{-1} + x^TS_Nx\\right)^{-1}x^TS_N.$$\n",
    "\n",
    "Lo primero que notamos es que el paréntesis que aparece en la fórmula corresponde a un número escalar, Por lo que la expresión de $L$:\n",
    "\n",
    "$$L = S_N - \\frac{ S_Nxx^TS_N}{\\left(\\beta^{-1} + x^TS_Nx\\right)}$$ \n",
    "\n",
    "Con esto podemos calcular el valor de $a^{-1}$, la varianza de nuestra distribución final, ocupando $(****)$ y que:\n",
    "\n",
    "$$x^TLx = x^TS_Nx - x^T\\,\\frac{ S_Nxx^TS_N}{\\left(\\beta^{-1} + x^TS_Nx\\right)}\\,x =  x^TS_Nx - \\frac{(x^TS_Nx)^{2}}{\\left(\\beta^{-1} + x^TS_Nx\\right)}$$\n",
    "\n",
    "$$x^TLx = \\frac{\\beta^{-1}\\,x^TS_Nx}{\\left(\\beta^{-1} + x^TS_Nx\\right)}$$\n",
    "\n",
    "$$\\Longrightarrow\\hspace{0.2cm} 1- \\beta\\,x^TLx = 1- \\frac{x^TS_Nx}{\\left(\\beta^{-1} + x^TS_Nx\\right)} = \\frac{\\beta^{-1}}{\\left(\\beta^{-1} + x^TS_Nx\\right)}$$\n",
    "\n",
    "$$\\Longrightarrow\\hspace{0.2cm}a = \\beta\\,(1- \\beta\\,x^TLx) = \\frac{1}{\\left(\\beta^{-1} + x^TS_Nx\\right)}$$ \n",
    "\n",
    "$$\\Longrightarrow\\hspace{0.2cm}a^{-1} =\\beta^{-1} + x^TS_Nx$$\n",
    "\n",
    "Así mismo para la media $b$, por lo encontrado en $(****)$:\n",
    "\n",
    "$$LS_N^{-1} = I - \\frac{ S_Nxx^T}{\\left(\\beta^{-1} + x^TS_Nx\\right)}$$\n",
    "\n",
    "$$\\Longrightarrow\\hspace{0.2cm}x^TLS_N^{-1} = x^T - \\frac{ x^TS_Nxx^T}{\\left(\\beta^{-1} + x^TS_Nx\\right)} = \\frac{\\beta^{-1}x^T}{\\left(\\beta^{-1} + x^TS_Nx\\right)}$$\n",
    "\n",
    "$$\\Longrightarrow\\hspace{0.2cm}x^TLS_N^{-1}m_N = \\frac{\\beta^{-1}x^Tm_N}{\\left(\\beta^{-1} + x^TS_Nx\\right)},$$\n",
    "\n",
    "sólo falta dividir por el término $\\left(1 -\\beta\\,x^TLx\\right) = a\\beta^{-1}$, según lo encontrado en $(****)$:\n",
    "\n",
    "$$\\Longrightarrow\\hspace{0.2cm}b = \\frac{x^TLS_N^{-1}m_N}{\\left(1 -\\beta\\,x^TLx\\right)} = \\frac{\\beta^{-1}x^Tm_N}{a\\beta^{-1}\\left(\\beta^{-1} + x^TS_Nx\\right)} = \\frac{x^Tm_Na^{-1}}{\\left(\\beta^{-1} + x^TS_Nx\\right)}$$\n",
    "\n",
    "$$\\Longrightarrow\\hspace{0.2cm}b =\\frac{x^Tm_N}{\\left(\\beta^{-1} + x^TS_Nx\\right)}\\left(\\beta^{-1} + x^TS_Nx\\right) = x^Tm_N$$.\n",
    "\n",
    "Así, recordando que $b$ era la media y $a^{-1}$ la varianza de una distribución normal, volviendo a la notación original $y'$ y usando que tener esta distribución proporcional a una normal la hace, efectivamente, normal:\n",
    "\n",
    "$$p(y'|x',y,X,\\alpha,\\beta)\\sim \\mathcal{N}(x'^Tm_N,\\sigma_N^2(x'))$$\n",
    "\n",
    "donde:\n",
    "\n",
    "$$\\sigma_N^2(x') = \\frac{1}{\\beta} + x'^TS_Nx'$$"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "3. Hacer estimaciones con este modelo requiere de los parámetros $\\alpha$ y $\\beta$. Para estimarlos, se utilizará la información contenida en los datos, esto se denomina $\\textit{enfoque bayesiano empírico}$. Use el teorema de probabilidades totales para deducir que la log-verosimilitud de $p(\\textbf{y}|\\alpha,\\beta)$ tiene la forma:\n",
    "\n",
    "$$log\\,p(\\textbf{y}|\\alpha, \\beta) = \\frac{d}{2}log\\,\\alpha + \\frac{N}{2}log\\,\\beta - E(m_N) - \\frac{1}{2}log\\,|S_N^{-1}| - \\frac{N}{2}log\\,2\\pi\\tag{3}$$\n",
    "\n",
    "donde\n",
    "\n",
    "$$E(\\textbf{m}_N) = \\frac{\\beta}{2}||\\textbf{y} - \\textbf{X}m_N||_2^2  + \\frac{\\alpha}{2}m_N^Tm_N$$\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": []
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Implementación:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "import sklearn.base as sk\n",
    "\n",
    "class RegresionBayes(BaseEstimator,RegresorMixin):\n",
    "    \n",
    "    def __init__(self,alpha_0,beta_0,tol = 1e-5, maxiter = 200):\n",
    "        self"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.4"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
